# WeKnora å®å¡”é¢æ¿éƒ¨ç½²æŒ‡å—

æœ¬æŒ‡å—è¯¦ç»†ä»‹ç»å¦‚ä½•åœ¨å®å¡”é¢æ¿çš„ç½‘ç«™ç›®å½•ä¸‹éƒ¨ç½² WeKnora é¡¹ç›®ï¼Œé€‚ç”¨äºŽäºŒæ¬¡å¼€å‘åŽçš„æµ‹è¯•å’Œç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²ã€‚

## ðŸ“‹ ç›®å½•

- [çŽ¯å¢ƒè¦æ±‚](#çŽ¯å¢ƒè¦æ±‚)
- [éƒ¨ç½²æž¶æž„è¯´æ˜Ž](#éƒ¨ç½²æž¶æž„è¯´æ˜Ž)
- [éƒ¨ç½²æ­¥éª¤](#éƒ¨ç½²æ­¥éª¤)
  - [1. å‡†å¤‡å·¥ä½œ](#1-å‡†å¤‡å·¥ä½œ)
  - [2. å®‰è£…ä¾èµ–æœåŠ¡](#2-å®‰è£…ä¾èµ–æœåŠ¡)
  - [3. é…ç½®æ•°æ®åº“](#3-é…ç½®æ•°æ®åº“)
  - [4. éƒ¨ç½²åŽç«¯æœåŠ¡](#4-éƒ¨ç½²åŽç«¯æœåŠ¡)
  - [5. éƒ¨ç½²æ–‡æ¡£è§£æžæœåŠ¡](#5-éƒ¨ç½²æ–‡æ¡£è§£æžæœåŠ¡)
  - [6. éƒ¨ç½²å‰ç«¯](#6-éƒ¨ç½²å‰ç«¯)
  - [7. é…ç½®Nginxåå‘ä»£ç†](#7-é…ç½®nginxåå‘ä»£ç†)
- [æœåŠ¡ç®¡ç†](#æœåŠ¡ç®¡ç†)
- [å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)

---

## çŽ¯å¢ƒè¦æ±‚

### æœåŠ¡å™¨é…ç½®æŽ¨è
- **CPU**: 4æ ¸åŠä»¥ä¸Š
- **å†…å­˜**: 8GBåŠä»¥ä¸Š
- **ç¡¬ç›˜**: 100GBåŠä»¥ä¸Šï¼ˆSSDæŽ¨èï¼‰
- **æ“ä½œç³»ç»Ÿ**: CentOS 7/8, Ubuntu 18.04/20.04/22.04
- **å®å¡”é¢æ¿**: 7.x æˆ–æ›´é«˜ç‰ˆæœ¬

### å¿…éœ€è½¯ä»¶
- **å®å¡”é¢æ¿**: å·²å®‰è£…å¹¶æ­£å¸¸è¿è¡Œ
- **Go**: 1.24.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Python**: 3.8 æˆ–æ›´é«˜ç‰ˆæœ¬
- **Node.js**: 16.x æˆ–æ›´é«˜ç‰ˆæœ¬
- **PostgreSQL**: 13 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼ˆæŽ¨èä½¿ç”¨ ParadeDBï¼‰
- **Redis**: 7.0 æˆ–æ›´é«˜ç‰ˆæœ¬
- **MinIO**: ç”¨äºŽå¯¹è±¡å­˜å‚¨ï¼ˆæˆ–ä½¿ç”¨æœ¬åœ°å­˜å‚¨ï¼‰
- **Nginx**: 1.18 æˆ–æ›´é«˜ç‰ˆæœ¬

---

## éƒ¨ç½²æž¶æž„è¯´æ˜Ž

WeKnora é¡¹ç›®ç”±ä»¥ä¸‹ç»„ä»¶æž„æˆï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Nginx (å®å¡”é¢æ¿ç®¡ç†)                â”‚
â”‚         ç«¯å£: 80/443 (åŸŸå: your-domain.com)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚                          â”‚
    â–¼                          â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  å‰ç«¯é™æ€  â”‚            â”‚   APIåå‘ä»£ç†  â”‚
â”‚   æ–‡ä»¶    â”‚            â”‚  /api/* è·¯å¾„   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   WeKnora åŽç«¯æœåŠ¡    â”‚
                    â”‚   ç«¯å£: 8080          â”‚
                    â”‚   (Go åº”ç”¨)           â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                  â”‚
        â–¼                   â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL  â”‚   â”‚    Redis    â”‚   â”‚  DocReader   â”‚
â”‚  ç«¯å£: 5432   â”‚   â”‚  ç«¯å£: 6379  â”‚   â”‚ ç«¯å£: 50051   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  (Python)    â”‚
                                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚    MinIO     â”‚
                    â”‚  ç«¯å£: 9000   â”‚
                    â”‚  (å¯¹è±¡å­˜å‚¨)    â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## éƒ¨ç½²æ­¥éª¤

### 1. å‡†å¤‡å·¥ä½œ

#### 1.1 åˆ›å»ºç½‘ç«™ç›®å½•

åœ¨å®å¡”é¢æ¿ä¸­åˆ›å»ºç½‘ç«™ï¼š

1. ç™»å½•å®å¡”é¢æ¿
2. ç‚¹å‡»"ç½‘ç«™" -> "æ·»åŠ ç«™ç‚¹"
3. å¡«å†™åŸŸåï¼šå¦‚ `weknora.yourdomain.com`
4. é€‰æ‹© PHP ç‰ˆæœ¬ï¼šçº¯é™æ€ï¼ˆå› ä¸ºå‰ç«¯æ˜¯ Vue é¡¹ç›®ï¼‰
5. åˆ›å»º FTP å’Œæ•°æ®åº“ï¼ˆå¯é€‰ï¼‰
6. ç‚¹å‡»"æäº¤"

å‡è®¾åˆ›å»ºçš„ç½‘ç«™ç›®å½•ä¸ºï¼š`/www/wwwroot/weknora.yourdomain.com`

#### 1.2 ä¸Šä¼ é¡¹ç›®ä»£ç 

é€šè¿‡ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€ä¸Šä¼ ä»£ç ï¼š

**æ–¹å¼ä¸€ï¼šä½¿ç”¨ Gitï¼ˆæŽ¨èï¼‰**

SSH ç™»å½•æœåŠ¡å™¨ï¼Œæ‰§è¡Œï¼š

```bash
cd /www/wwwroot/weknora.yourdomain.com
# åˆ é™¤é»˜è®¤æ–‡ä»¶
rm -rf *

# å…‹éš†é¡¹ç›®ï¼ˆå¦‚æžœæ˜¯ç§æœ‰ä»“åº“ï¼Œéœ€è¦é…ç½® SSH å¯†é’¥ï¼‰
git clone https://github.com/Tencent/WeKnora.git .

# æˆ–è€…å…‹éš†ä½ çš„äºŒå¼€ä»“åº“
# git clone https://your-git-repo/WeKnora.git .
```

**æ–¹å¼äºŒï¼šä½¿ç”¨å®å¡”æ–‡ä»¶ç®¡ç†å™¨**

1. åœ¨æœ¬åœ°æ‰“åŒ…é¡¹ç›®ä¸º `weknora.zip`
2. åœ¨å®å¡”é¢æ¿ -> æ–‡ä»¶ -> ä¸Šä¼ 
3. ä¸Šä¼ åˆ° `/www/wwwroot/weknora.yourdomain.com`
4. è§£åŽ‹

#### 1.3 è®¾ç½®ç›®å½•æƒé™

```bash
cd /www/wwwroot/weknora.yourdomain.com
chown -R www:www .
chmod -R 755 .
```

---

### 2. å®‰è£…ä¾èµ–æœåŠ¡

#### 2.1 å®‰è£… Go çŽ¯å¢ƒ

åœ¨å®å¡”é¢æ¿çš„è½¯ä»¶å•†åº—æœç´¢å¹¶å®‰è£…"Go"ï¼Œæˆ–æ‰‹åŠ¨å®‰è£…ï¼š

```bash
# ä¸‹è½½ Go 1.24.2
cd /tmp
wget https://go.dev/dl/go1.24.2.linux-amd64.tar.gz

# å®‰è£…
rm -rf /usr/local/go
tar -C /usr/local -xzf go1.24.2.linux-amd64.tar.gz

# é…ç½®çŽ¯å¢ƒå˜é‡
echo 'export PATH=$PATH:/usr/local/go/bin' >> /etc/profile
echo 'export GOPATH=/root/go' >> /etc/profile
source /etc/profile

# éªŒè¯å®‰è£…
go version
```

é…ç½® Go ä»£ç†ï¼ˆåŠ é€Ÿä¾èµ–ä¸‹è½½ï¼‰ï¼š

```bash
go env -w GO111MODULE=on
go env -w GOPROXY=https://goproxy.cn,direct
```

#### 2.2 å®‰è£… Python çŽ¯å¢ƒ

å®å¡”é¢æ¿é€šå¸¸å·²å®‰è£… Pythonï¼Œæ£€æŸ¥ç‰ˆæœ¬ï¼š

```bash
python3 --version
```

å¦‚æžœç‰ˆæœ¬ä½ŽäºŽ 3.8ï¼Œéœ€è¦å‡çº§æˆ–å®‰è£…ï¼š

```bash
# CentOS
yum install python38 python38-pip

# Ubuntu
apt install python3.8 python3-pip
```

å®‰è£… Poetryï¼ˆPython ä¾èµ–ç®¡ç†å·¥å…·ï¼‰ï¼š

```bash
curl -sSL https://install.python-poetry.org | python3 -
export PATH="/root/.local/bin:$PATH"
echo 'export PATH="/root/.local/bin:$PATH"' >> ~/.bashrc
```

#### 2.3 å®‰è£… Node.js çŽ¯å¢ƒ

åœ¨å®å¡”é¢æ¿è½¯ä»¶å•†åº—å®‰è£…"PM2ç®¡ç†å™¨"ï¼Œå®ƒä¼šè‡ªåŠ¨å®‰è£… Node.jsã€‚

æˆ–æ‰‹åŠ¨å®‰è£…ï¼š

```bash
# å®‰è£… nvm
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.39.0/install.sh | bash
source ~/.bashrc

# å®‰è£… Node.js 18
nvm install 18
nvm use 18
node -v
npm -v
```

---

### 3. é…ç½®æ•°æ®åº“

#### 3.1 å®‰è£… PostgreSQL

åœ¨å®å¡”é¢æ¿è½¯ä»¶å•†åº—æœç´¢å¹¶å®‰è£…"PostgreSQL"ï¼ˆæŽ¨è 13 æˆ–æ›´é«˜ç‰ˆæœ¬ï¼‰ã€‚

**æ³¨æ„**ï¼šå¦‚æžœéœ€è¦ä½¿ç”¨å‘é‡æœç´¢åŠŸèƒ½ï¼ŒæŽ¨èæ‰‹åŠ¨å®‰è£… ParadeDBã€‚

**å®‰è£… ParadeDBï¼ˆå¯é€‰ï¼Œæ”¯æŒå…¨æ–‡æœç´¢å’Œå‘é‡æœç´¢ï¼‰**ï¼š

```bash
# ä½¿ç”¨ Docker å®‰è£… ParadeDBï¼ˆæŽ¨èï¼‰
docker pull paradedb/paradedb:latest
docker run -d \
  --name weknora-postgres \
  -p 5432:5432 \
  -e POSTGRES_USER=weknora \
  -e POSTGRES_PASSWORD=your_secure_password \
  -e POSTGRES_DB=weknora \
  -v /www/server/data/postgres:/var/lib/postgresql/data \
  paradedb/paradedb:latest
```

æˆ–åœ¨å®å¡”é¢æ¿å®‰è£…çš„ PostgreSQL åŸºç¡€ä¸Šæ·»åŠ  pgvector æ‰©å±•ã€‚

#### 3.2 åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·

ç™»å½• PostgreSQLï¼š

```bash
# å¦‚æžœä½¿ç”¨å®å¡”é¢æ¿å®‰è£…çš„ PostgreSQL
su - postgres
psql

# æˆ–ä½¿ç”¨ Docker å®‰è£…çš„
docker exec -it weknora-postgres psql -U postgres
```

åˆ›å»ºæ•°æ®åº“å’Œç”¨æˆ·ï¼š

```sql
-- åˆ›å»ºç”¨æˆ·
CREATE USER weknora WITH PASSWORD 'your_secure_password';

-- åˆ›å»ºæ•°æ®åº“
CREATE DATABASE weknora OWNER weknora;

-- æŽˆæƒ
GRANT ALL PRIVILEGES ON DATABASE weknora TO weknora;

-- é€€å‡º
\q
```

#### 3.3 åˆå§‹åŒ–æ•°æ®åº“

æ‰§è¡Œæ•°æ®åº“åˆå§‹åŒ–è„šæœ¬ï¼š

```bash
cd /www/wwwroot/weknora.yourdomain.com

# å¦‚æžœä½¿ç”¨ ParadeDB
psql -h localhost -U weknora -d weknora -f migrations/paradedb/00-init-db.sql
psql -h localhost -U weknora -d weknora -f migrations/paradedb/01-migrate-to-paradedb.sql

# å¦‚æžœä½¿ç”¨æ™®é€š PostgreSQL + pgvector
psql -h localhost -U weknora -d weknora -f migrations/mysql/00-init-db.sql
```

è¾“å…¥å¯†ç åŽæ‰§è¡Œã€‚

#### 3.4 å®‰è£… Redis

åœ¨å®å¡”é¢æ¿è½¯ä»¶å•†åº—æœç´¢å¹¶å®‰è£…"Redis"ã€‚

å®‰è£…å®ŒæˆåŽï¼š
1. ç‚¹å‡»"è®¾ç½®" -> "é…ç½®ä¿®æ”¹"
2. è®¾ç½®å¯†ç ï¼ˆæ‰¾åˆ° `requirepass`ï¼Œè®¾ç½®å¼ºå¯†ç ï¼‰
3. é‡å¯ Redis

#### 3.5 å®‰è£… MinIOï¼ˆå¯¹è±¡å­˜å‚¨ï¼‰

**ä½¿ç”¨ Docker å®‰è£… MinIO**ï¼š

```bash
docker pull minio/minio:latest
docker run -d \
  --name weknora-minio \
  -p 9000:9000 \
  -p 9001:9001 \
  -e MINIO_ROOT_USER=minioadmin \
  -e MINIO_ROOT_PASSWORD=minioadmin \
  -v /www/server/data/minio:/data \
  minio/minio:latest server /data --console-address ":9001"
```

**æˆ–ä½¿ç”¨æœ¬åœ°å­˜å‚¨**ï¼ˆè·³è¿‡ MinIO å®‰è£…ï¼Œåœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½® `STORAGE_TYPE=local`ï¼‰ã€‚

---

### 4. éƒ¨ç½²åŽç«¯æœåŠ¡

#### 4.1 é…ç½®çŽ¯å¢ƒå˜é‡

åˆ›å»º `.env` æ–‡ä»¶ï¼š

```bash
cd /www/wwwroot/weknora.yourdomain.com
cat > .env << 'EOF'
# æ•°æ®åº“é…ç½®
DB_DRIVER=postgres
DB_HOST=localhost
DB_PORT=5432
DB_USER=weknora
DB_PASSWORD=your_secure_password
DB_NAME=weknora

# Redis é…ç½®
REDIS_ADDR=localhost:6379
REDIS_PASSWORD=your_redis_password
REDIS_DB=0
REDIS_PREFIX=weknora:

# å­˜å‚¨é…ç½®ï¼ˆé€‰æ‹©ä¸€ç§ï¼‰
# ä½¿ç”¨æœ¬åœ°å­˜å‚¨
STORAGE_TYPE=local
LOCAL_STORAGE_BASE_DIR=/www/wwwroot/weknora.yourdomain.com/data/files

# æˆ–ä½¿ç”¨ MinIO
# STORAGE_TYPE=minio
# MINIO_ENDPOINT=localhost:9000
# MINIO_ACCESS_KEY_ID=minioadmin
# MINIO_SECRET_ACCESS_KEY=minioadmin
# MINIO_BUCKET_NAME=weknora
# MINIO_USE_SSL=false

# åº”ç”¨é…ç½®
APP_PORT=8080
FRONTEND_PORT=80
GIN_MODE=release

# DocReader æœåŠ¡åœ°å€
DOCREADER_ADDR=localhost:50051

# Ollama é…ç½®ï¼ˆå¦‚æžœä½¿ç”¨æœ¬åœ° LLMï¼‰
OLLAMA_BASE_URL=http://localhost:11434

# æ£€ç´¢å¼•æ“Žé…ç½®
RETRIEVE_DRIVER=postgres  # æˆ– elasticsearch

# æµç®¡ç†å™¨ç±»åž‹
STREAM_MANAGER_TYPE=memory  # æˆ– redis

# çŸ¥è¯†å›¾è°±é…ç½®
ENABLE_GRAPH_RAG=false  # æ˜¯å¦å¯ç”¨çŸ¥è¯†å›¾è°±

# ç§Ÿæˆ·åŠ å¯†å¯†é’¥ï¼ˆ32ä½éšæœºå­—ç¬¦ä¸²ï¼‰
TENANT_AES_KEY=your-32-character-random-key-here

# å¹¶å‘æ± å¤§å°
CONCURRENCY_POOL_SIZE=5

# åˆå§‹åŒ–æ¨¡åž‹é…ç½®ï¼ˆå¯é€‰ï¼Œä¹Ÿå¯ä»¥é€šè¿‡ Web UI é…ç½®ï¼‰
# INIT_LLM_MODEL_NAME=qwen2.5
# INIT_LLM_MODEL_BASE_URL=http://localhost:11434
# INIT_LLM_MODEL_API_KEY=

# INIT_EMBEDDING_MODEL_NAME=bge-large-zh
# INIT_EMBEDDING_MODEL_BASE_URL=http://localhost:11434
# INIT_EMBEDDING_MODEL_API_KEY=
# INIT_EMBEDDING_MODEL_DIMENSION=1024

EOF
```

**é‡è¦**ï¼šä¿®æ”¹ä»¥ä¸Šé…ç½®ä¸­çš„å¯†ç å’Œå¯†é’¥ä¸ºä½ è‡ªå·±çš„å®‰å…¨å€¼ã€‚

ç”Ÿæˆéšæœºå¯†é’¥ï¼š

```bash
# ç”Ÿæˆ 32 ä½éšæœºå¯†é’¥
openssl rand -hex 16
```

#### 4.2 åˆ›å»ºå¿…è¦çš„ç›®å½•

```bash
mkdir -p /www/wwwroot/weknora.yourdomain.com/data/files
chown -R www:www /www/wwwroot/weknora.yourdomain.com/data
```

#### 4.3 ç¼–è¯‘åŽç«¯æœåŠ¡

```bash
cd /www/wwwroot/weknora.yourdomain.com

# ä¸‹è½½ Go ä¾èµ–
go mod download

# ç¼–è¯‘
go build -o WeKnora -ldflags="-w -s" ./cmd/server

# è®¾ç½®å¯æ‰§è¡Œæƒé™
chmod +x WeKnora
```

#### 4.4 ä½¿ç”¨ PM2 ç®¡ç†åŽç«¯æœåŠ¡

åœ¨å®å¡”é¢æ¿å®‰è£…"PM2ç®¡ç†å™¨"æ’ä»¶ã€‚

æˆ–æ‰‹åŠ¨å®‰è£… PM2ï¼š

```bash
npm install -g pm2
```

åˆ›å»º PM2 é…ç½®æ–‡ä»¶ï¼š

```bash
cd /www/wwwroot/weknora.yourdomain.com
cat > ecosystem.config.js << 'EOF'
module.exports = {
  apps: [
    {
      name: 'weknora-app',
      script: './WeKnora',
      cwd: '/www/wwwroot/weknora.yourdomain.com',
      instances: 1,
      autorestart: true,
      watch: false,
      max_memory_restart: '1G',
      env: {
        NODE_ENV: 'production'
      },
      error_file: '/www/wwwroot/weknora.yourdomain.com/logs/app-error.log',
      out_file: '/www/wwwroot/weknora.yourdomain.com/logs/app-out.log',
      log_date_format: 'YYYY-MM-DD HH:mm:ss',
      merge_logs: true
    }
  ]
};
EOF

# åˆ›å»ºæ—¥å¿—ç›®å½•
mkdir -p logs

# å¯åŠ¨æœåŠ¡
pm2 start ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status

# æŸ¥çœ‹æ—¥å¿—
pm2 logs weknora-app

# è®¾ç½®å¼€æœºè‡ªå¯
pm2 startup
pm2 save
```

---

### 5. éƒ¨ç½²æ–‡æ¡£è§£æžæœåŠ¡

#### 5.1 å®‰è£… Python ä¾èµ–

```bash
cd /www/wwwroot/weknora.yourdomain.com/services/docreader

# ä½¿ç”¨ Poetry å®‰è£…ä¾èµ–
poetry install

# æˆ–ä½¿ç”¨ pip
pip3 install -r requirements.txt
```

#### 5.2 é…ç½® DocReader æœåŠ¡

DocReader æœåŠ¡ä¼šè¯»å–çŽ¯å¢ƒå˜é‡ï¼Œç¡®ä¿ `.env` æ–‡ä»¶ä¸­æœ‰ä»¥ä¸‹é…ç½®ï¼š

```bash
# DocReader ç›¸å…³é…ç½®
STORAGE_TYPE=local
MINIO_PUBLIC_ENDPOINT=http://localhost:9000
MINIO_ENDPOINT=localhost:9000
MINIO_ACCESS_KEY_ID=minioadmin
MINIO_SECRET_ACCESS_KEY=minioadmin
MINIO_BUCKET_NAME=weknora
MINIO_USE_SSL=false

# è§†è§‰è¯­è¨€æ¨¡åž‹é…ç½®ï¼ˆç”¨äºŽå›¾åƒè¯†åˆ«ï¼Œå¯é€‰ï¼‰
# VLM_MODEL_BASE_URL=http://localhost:11434
# VLM_MODEL_NAME=llava
# VLM_MODEL_API_KEY=

# Web ä»£ç†ï¼ˆå¦‚æžœéœ€è¦ï¼‰
# WEB_PROXY=http://proxy.example.com:8080
```

#### 5.3 å¯åŠ¨ DocReader æœåŠ¡

ä½¿ç”¨ PM2 ç®¡ç† DocReader æœåŠ¡ï¼š

```bash
cd /www/wwwroot/weknora.yourdomain.com

# æ·»åŠ åˆ° ecosystem.config.js
cat >> ecosystem.config.js << 'EOF'

  apps.push({
    name: 'weknora-docreader',
    script: 'poetry',
    args: 'run python src/server/server.py',
    cwd: '/www/wwwroot/weknora.yourdomain.com/services/docreader',
    instances: 1,
    autorestart: true,
    watch: false,
    max_memory_restart: '2G',
    env: {
      NODE_ENV: 'production'
    },
    error_file: '/www/wwwroot/weknora.yourdomain.com/logs/docreader-error.log',
    out_file: '/www/wwwroot/weknora.yourdomain.com/logs/docreader-out.log',
    log_date_format: 'YYYY-MM-DD HH:mm:ss',
    merge_logs: true
  });
EOF

# é‡æ–°åŠ è½½é…ç½®
pm2 reload ecosystem.config.js

# æŸ¥çœ‹çŠ¶æ€
pm2 status
```

æˆ–ç›´æŽ¥å¯åŠ¨ï¼š

```bash
cd /www/wwwroot/weknora.yourdomain.com/services/docreader
nohup poetry run python src/server/server.py > /www/wwwroot/weknora.yourdomain.com/logs/docreader.log 2>&1 &
```

---

### 6. éƒ¨ç½²å‰ç«¯

#### 6.1 æž„å»ºå‰ç«¯é¡¹ç›®

```bash
cd /www/wwwroot/weknora.yourdomain.com/frontend

# å®‰è£…ä¾èµ–
npm install

# æž„å»ºç”Ÿäº§ç‰ˆæœ¬
npm run build

# æž„å»ºå®ŒæˆåŽï¼Œdist ç›®å½•åŒ…å«æ‰€æœ‰é™æ€æ–‡ä»¶
```

#### 6.2 é…ç½®å‰ç«¯é™æ€æ–‡ä»¶ç›®å½•

å‰ç«¯æž„å»ºå®ŒæˆåŽï¼Œé™æ€æ–‡ä»¶åœ¨ `frontend/dist` ç›®å½•ã€‚

ä½ éœ€è¦å°†è¿™äº›æ–‡ä»¶æ”¾åˆ° Nginx å¯è®¿é—®çš„ç›®å½•ï¼š

**æ–¹å¼ä¸€ï¼šç›´æŽ¥ä½¿ç”¨ dist ç›®å½•**

```bash
# åˆ›å»ºç¬¦å·é“¾æŽ¥
ln -s /www/wwwroot/weknora.yourdomain.com/frontend/dist /www/wwwroot/weknora.yourdomain.com/public
```

**æ–¹å¼äºŒï¼šå¤åˆ¶åˆ°ç½‘ç«™æ ¹ç›®å½•**

```bash
cp -r /www/wwwroot/weknora.yourdomain.com/frontend/dist/* /www/wwwroot/weknora.yourdomain.com/public/
```

---

### 7. é…ç½®Nginxåå‘ä»£ç†

#### 7.1 åœ¨å®å¡”é¢æ¿é…ç½® Nginx

1. æ‰“å¼€å®å¡”é¢æ¿ -> ç½‘ç«™ -> æ‰¾åˆ°ä½ çš„ç«™ç‚¹ï¼ˆweknora.yourdomain.comï¼‰
2. ç‚¹å‡»"è®¾ç½®" -> "é…ç½®æ–‡ä»¶"
3. æ›¿æ¢æˆ–ä¿®æ”¹ä¸ºä»¥ä¸‹é…ç½®ï¼š

```nginx
server {
    listen 80;
    server_name weknora.yourdomain.com;  # ä¿®æ”¹ä¸ºä½ çš„åŸŸå
    
    # å¦‚æžœé…ç½®äº† SSLï¼Œæ·»åŠ ä»¥ä¸‹è¡Œ
    # listen 443 ssl http2;
    # ssl_certificate /path/to/your/cert.pem;
    # ssl_certificate_key /path/to/your/key.pem;
    
    root /www/wwwroot/weknora.yourdomain.com/frontend/dist;
    index index.html;
    
    client_max_body_size 50M;
    
    # å®‰å…¨å¤´é…ç½®
    add_header X-Frame-Options "SAMEORIGIN" always;
    add_header X-Content-Type-Options "nosniff" always;
    add_header X-XSS-Protection "1; mode=block" always;
    add_header Referrer-Policy "strict-origin-when-cross-origin" always;
    
    # è®¿é—®æ—¥å¿—å’Œé”™è¯¯æ—¥å¿—
    access_log /www/wwwlogs/weknora.yourdomain.com.log;
    error_log /www/wwwlogs/weknora.yourdomain.com.error.log;
    
    # å‰ç«¯é™æ€æ–‡ä»¶
    location / {
        try_files $uri $uri/ /index.html;
    }
    
    # API è¯·æ±‚ä»£ç†åˆ°åŽç«¯æœåŠ¡
    location /api/ {
        proxy_pass http://127.0.0.1:8080/api/;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # è¿žæŽ¥å’Œé‡è¯•é…ç½®
        proxy_connect_timeout 30s;
        proxy_next_upstream error timeout invalid_header http_500 http_502 http_503 http_504;
        proxy_next_upstream_tries 3;
        proxy_next_upstream_timeout 30s;
        
        # SSE ç›¸å…³é…ç½®ï¼ˆæµå¼å“åº”ï¼‰
        proxy_http_version 1.1;
        proxy_set_header Connection "";
        chunked_transfer_encoding off;
        proxy_buffering off;
        proxy_cache off;
        proxy_read_timeout 3600s;
        proxy_send_timeout 3600s;
    }
    
    # é”™è¯¯é¡µé¢
    error_page 500 502 503 504 /50x.html;
    location = /50x.html {
        root /www/wwwroot/weknora.yourdomain.com/frontend/dist;
    }
}
```

4. ç‚¹å‡»"ä¿å­˜"
5. é‡å¯ Nginxï¼šåœ¨å®å¡”é¢æ¿ -> è½¯ä»¶å•†åº— -> Nginx -> é‡å¯

#### 7.2 é…ç½® SSLï¼ˆå¯é€‰ä½†æŽ¨èï¼‰

1. åœ¨å®å¡”é¢æ¿ -> ç½‘ç«™ -> è®¾ç½® -> SSL
2. é€‰æ‹©"Let's Encrypt" æˆ–ä¸Šä¼ ä½ çš„è¯ä¹¦
3. ç”³è¯·å¹¶éƒ¨ç½²è¯ä¹¦
4. å¼€å¯"å¼ºåˆ¶HTTPS"

---

## æœåŠ¡ç®¡ç†

### å¯åŠ¨æ‰€æœ‰æœåŠ¡

```bash
# å¯åŠ¨åŽç«¯å’Œ DocReader
pm2 start ecosystem.config.js

# å¯åŠ¨ PostgreSQLï¼ˆå¦‚æžœä½¿ç”¨ Dockerï¼‰
docker start weknora-postgres

# å¯åŠ¨ Redisï¼ˆå®å¡”é¢æ¿ç®¡ç†ï¼‰
# åœ¨å®å¡”é¢æ¿ -> è½¯ä»¶å•†åº— -> Redis -> å¯åŠ¨

# å¯åŠ¨ MinIOï¼ˆå¦‚æžœä½¿ç”¨ï¼‰
docker start weknora-minio

# é‡å¯ Nginx
/etc/init.d/nginx restart
```

### åœæ­¢æ‰€æœ‰æœåŠ¡

```bash
# åœæ­¢åŽç«¯å’Œ DocReader
pm2 stop all

# åœæ­¢ PostgreSQL
docker stop weknora-postgres

# åœæ­¢ MinIO
docker stop weknora-minio
```

### æŸ¥çœ‹æœåŠ¡çŠ¶æ€

```bash
# æŸ¥çœ‹ PM2 ç®¡ç†çš„æœåŠ¡
pm2 status
pm2 logs weknora-app
pm2 logs weknora-docreader

# æŸ¥çœ‹ Docker å®¹å™¨
docker ps -a

# æŸ¥çœ‹ Nginx çŠ¶æ€
/etc/init.d/nginx status
```

### æ›´æ–°ä»£ç åŽé‡æ–°éƒ¨ç½²

```bash
cd /www/wwwroot/weknora.yourdomain.com

# æ‹‰å–æœ€æ–°ä»£ç 
git pull

# é‡æ–°ç¼–è¯‘åŽç«¯
go build -o WeKnora -ldflags="-w -s" ./cmd/server

# é‡æ–°æž„å»ºå‰ç«¯
cd frontend
npm install
npm run build
cd ..

# é‡å¯æœåŠ¡
pm2 restart weknora-app
pm2 restart weknora-docreader

# é‡å¯ Nginx
/etc/init.d/nginx restart
```

---

## å¸¸è§é—®é¢˜

### 1. åŽç«¯æœåŠ¡æ— æ³•è¿žæŽ¥æ•°æ®åº“

**é—®é¢˜**ï¼šåŽç«¯æ—¥å¿—æ˜¾ç¤º `connection refused` æˆ– `could not connect to database`

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ PostgreSQL æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š`docker ps` æˆ– `systemctl status postgresql`
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„æ•°æ®åº“é…ç½®æ˜¯å¦æ­£ç¡®
- ç¡®ä¿ PostgreSQL ç›‘å¬çš„ç«¯å£ï¼ˆ5432ï¼‰æ²¡æœ‰è¢«é˜²ç«å¢™é˜»æ­¢

```bash
# æ£€æŸ¥ç«¯å£
netstat -tlnp | grep 5432

# æµ‹è¯•è¿žæŽ¥
psql -h localhost -U weknora -d weknora -c "SELECT 1;"
```

### 2. å‰ç«¯æ˜¾ç¤ºç©ºç™½é¡µé¢

**é—®é¢˜**ï¼šè®¿é—®ç½‘ç«™æ˜¾ç¤ºç©ºç™½æˆ– 404

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥å‰ç«¯æ˜¯å¦æ­£ç¡®æž„å»ºï¼š`ls frontend/dist`
- æ£€æŸ¥ Nginx é…ç½®ä¸­çš„ `root` è·¯å¾„æ˜¯å¦æ­£ç¡®
- æŸ¥çœ‹æµè§ˆå™¨æŽ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥ Nginx é”™è¯¯æ—¥å¿—ï¼š`tail -f /www/wwwlogs/weknora.yourdomain.com.error.log`

### 3. API è¯·æ±‚å¤±è´¥ï¼ˆ502 Bad Gatewayï¼‰

**é—®é¢˜**ï¼šå‰ç«¯åŠ è½½æ­£å¸¸ï¼Œä½† API è¯·æ±‚è¿”å›ž 502

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥åŽç«¯æœåŠ¡æ˜¯å¦æ­£åœ¨è¿è¡Œï¼š`pm2 status`
- æ£€æŸ¥åŽç«¯æ—¥å¿—ï¼š`pm2 logs weknora-app`
- ç¡®è®¤åŽç«¯ç›‘å¬çš„ç«¯å£ï¼ˆ8080ï¼‰ä¸Ž Nginx é…ç½®ä¸€è‡´
- æµ‹è¯•åŽç«¯æ˜¯å¦å¯è®¿é—®ï¼š`curl http://localhost:8080/api/v1/health`

### 4. æ–‡ä»¶ä¸Šä¼ å¤±è´¥

**é—®é¢˜**ï¼šä¸Šä¼ æ–‡ä»¶æ—¶æŠ¥é”™æˆ–è¶…æ—¶

**è§£å†³æ–¹æ¡ˆ**ï¼š
- æ£€æŸ¥ DocReader æœåŠ¡æ˜¯å¦è¿è¡Œï¼š`pm2 logs weknora-docreader`
- æ£€æŸ¥å­˜å‚¨é…ç½®ï¼ˆæœ¬åœ°å­˜å‚¨æˆ– MinIOï¼‰
- ç¡®è®¤å­˜å‚¨ç›®å½•æœ‰å†™æƒé™ï¼š`ls -la /www/wwwroot/weknora.yourdomain.com/data/files`
- æ£€æŸ¥ Nginx çš„ `client_max_body_size` è®¾ç½®

### 5. å†…å­˜å ç”¨è¿‡é«˜

**é—®é¢˜**ï¼šæœåŠ¡è¿è¡Œä¸€æ®µæ—¶é—´åŽå†…å­˜å ç”¨å¾ˆé«˜

**è§£å†³æ–¹æ¡ˆ**ï¼š
- åœ¨ PM2 é…ç½®ä¸­è®¾ç½® `max_memory_restart`ï¼ˆå·²è®¾ç½®ï¼‰
- å‡å°‘ `CONCURRENCY_POOL_SIZE` çš„å€¼
- å¦‚æžœä½¿ç”¨ Redis ä½œä¸º `STREAM_MANAGER_TYPE`ï¼Œç¡®ä¿ Redis æœ‰è¶³å¤Ÿå†…å­˜
- å®šæœŸé‡å¯æœåŠ¡ï¼š`pm2 restart all`

### 6. å¦‚ä½•æŸ¥çœ‹å®Œæ•´æ—¥å¿—

```bash
# åŽç«¯æ—¥å¿—
pm2 logs weknora-app --lines 100

# DocReader æ—¥å¿—
pm2 logs weknora-docreader --lines 100

# Nginx è®¿é—®æ—¥å¿—
tail -f /www/wwwlogs/weknora.yourdomain.com.log

# Nginx é”™è¯¯æ—¥å¿—
tail -f /www/wwwlogs/weknora.yourdomain.com.error.log

# PostgreSQL æ—¥å¿—ï¼ˆDockerï¼‰
docker logs weknora-postgres

# Redis æ—¥å¿—ï¼ˆå®å¡”é¢æ¿ï¼‰
# åœ¨å®å¡”é¢æ¿ -> è½¯ä»¶å•†åº— -> Redis -> æ—¥å¿—
```

### 7. å¦‚ä½•å¤‡ä»½æ•°æ®

```bash
# å¤‡ä»½æ•°æ®åº“
pg_dump -h localhost -U weknora -d weknora > /www/backup/weknora_$(date +%Y%m%d).sql

# å¤‡ä»½ä¸Šä¼ çš„æ–‡ä»¶
tar -czf /www/backup/weknora_files_$(date +%Y%m%d).tar.gz /www/wwwroot/weknora.yourdomain.com/data/files

# å¤‡ä»½é…ç½®æ–‡ä»¶
cp /www/wwwroot/weknora.yourdomain.com/.env /www/backup/weknora_env_$(date +%Y%m%d).bak
```

### 8. æ€§èƒ½ä¼˜åŒ–å»ºè®®

1. **å¯ç”¨ Nginx ç¼“å­˜**ï¼šå¯¹é™æ€èµ„æºæ·»åŠ ç¼“å­˜å¤´
2. **ä½¿ç”¨ Redis ä½œä¸ºæµç®¡ç†å™¨**ï¼šè®¾ç½® `STREAM_MANAGER_TYPE=redis`
3. **å¯ç”¨ CDN**ï¼šå°†é™æ€èµ„æºæ‰˜ç®¡åˆ° CDN
4. **æ•°æ®åº“ä¼˜åŒ–**ï¼šå®šæœŸæ‰§è¡Œ `VACUUM` å’Œ `ANALYZE`
5. **å¢žåŠ æœåŠ¡å™¨èµ„æº**ï¼šå¦‚æžœæµé‡å¤§ï¼Œè€ƒè™‘å¢žåŠ  CPU å’Œå†…å­˜

---

## æ€»ç»“

é€šè¿‡ä»¥ä¸Šæ­¥éª¤ï¼Œä½ å·²ç»æˆåŠŸåœ¨å®å¡”é¢æ¿ä¸Šéƒ¨ç½²äº† WeKnora é¡¹ç›®ã€‚ä¸»è¦ç»„ä»¶åŒ…æ‹¬ï¼š

- âœ… PostgreSQL æ•°æ®åº“
- âœ… Redis ç¼“å­˜
- âœ… MinIO å¯¹è±¡å­˜å‚¨ï¼ˆæˆ–æœ¬åœ°å­˜å‚¨ï¼‰
- âœ… Go åŽç«¯æœåŠ¡ï¼ˆPM2 ç®¡ç†ï¼‰
- âœ… Python DocReader æœåŠ¡ï¼ˆPM2 ç®¡ç†ï¼‰
- âœ… Vue å‰ç«¯ï¼ˆNginx æ‰˜ç®¡ï¼‰
- âœ… Nginx åå‘ä»£ç†

çŽ°åœ¨ä½ å¯ä»¥é€šè¿‡ `http://weknora.yourdomain.com` è®¿é—® WeKnora ç³»ç»Ÿäº†ï¼

é¦–æ¬¡è®¿é—®ä¼šè‡ªåŠ¨è·³è½¬åˆ°åˆå§‹åŒ–é…ç½®é¡µé¢ï¼ŒæŒ‰ç…§æç¤ºå®Œæˆæ¨¡åž‹é…ç½®å³å¯å¼€å§‹ä½¿ç”¨ã€‚

å¦‚æœ‰é—®é¢˜ï¼Œè¯·å‚è€ƒ[å¸¸è§é—®é¢˜](#å¸¸è§é—®é¢˜)æˆ–æŸ¥çœ‹é¡¹ç›®æ–‡æ¡£ã€‚

---

## é™„å½•ï¼šå¿«é€Ÿå‘½ä»¤å‚è€ƒ

```bash
# æœåŠ¡ç®¡ç†
pm2 start ecosystem.config.js     # å¯åŠ¨æ‰€æœ‰æœåŠ¡
pm2 stop all                       # åœæ­¢æ‰€æœ‰æœåŠ¡
pm2 restart all                    # é‡å¯æ‰€æœ‰æœåŠ¡
pm2 status                         # æŸ¥çœ‹æœåŠ¡çŠ¶æ€
pm2 logs                           # æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—
pm2 logs weknora-app               # æŸ¥çœ‹åŽç«¯æ—¥å¿—
pm2 logs weknora-docreader         # æŸ¥çœ‹ DocReader æ—¥å¿—

# Nginx ç®¡ç†
/etc/init.d/nginx start            # å¯åŠ¨ Nginx
/etc/init.d/nginx stop             # åœæ­¢ Nginx
/etc/init.d/nginx restart          # é‡å¯ Nginx
/etc/init.d/nginx reload           # é‡è½½é…ç½®
nginx -t                           # æµ‹è¯•é…ç½®æ–‡ä»¶

# Docker ç®¡ç†
docker ps                          # æŸ¥çœ‹è¿è¡Œä¸­çš„å®¹å™¨
docker ps -a                       # æŸ¥çœ‹æ‰€æœ‰å®¹å™¨
docker start weknora-postgres      # å¯åŠ¨ PostgreSQL
docker stop weknora-postgres       # åœæ­¢ PostgreSQL
docker logs weknora-postgres       # æŸ¥çœ‹æ—¥å¿—

# æ•°æ®åº“ç®¡ç†
psql -h localhost -U weknora -d weknora   # ç™»å½•æ•°æ®åº“
pg_dump -h localhost -U weknora -d weknora > backup.sql  # å¤‡ä»½
psql -h localhost -U weknora -d weknora < backup.sql     # æ¢å¤

# é¡¹ç›®æ›´æ–°
cd /www/wwwroot/weknora.yourdomain.com
git pull
go build -o WeKnora -ldflags="-w -s" ./cmd/server
cd frontend && npm run build && cd ..
pm2 restart all
```

---

**ç¥ä½ éƒ¨ç½²é¡ºåˆ©ï¼** ðŸŽ‰
